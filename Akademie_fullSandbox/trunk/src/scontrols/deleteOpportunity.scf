<html><head>
<script type="text/javascript">
  	var DEBUG = false;

	if (DEBUG) {
		document.write('<script language="javascript" src="https://www.salesforce.com/services/lib/ajax/beta3.3/sforceclient.js?browser=true" type="text/javascript"><\/script>');
	}
	else {
		document.write('<script language="javascript" src="https://www.salesforce.com/services/lib/ajax/beta3.3/sforceclient.js" type="text/javascript"><\/script>');
	}
</script>
<script src="/soap/ajax/8.0/connection.js"></script>

<script type="text/javascript">


		function initPage()	{
			//on body load
			sforceClient.init("{!API.Session_ID}", "{!API.Partner_Server_URL_80}", false);
			setTimeout("start()", 500);
			var outputsave="Einen Moment bitte, L&ouml;schvorgang wird durchgef&uuml;hrt ...";
			var textNode = document.createTextNode(outputsave);
			document.getElementById("outputsave").innerHTML = outputsave;
		}
		
		
		function start() {
		
			var queryopp="Select o.Id, o.Seminar__c, o.Stornokosten__c, o.Umsatz_Seminar__c, o.Stornogeb_hr__c, o.RecordTypeId From Opportunity o Where o.Id='{!Opportunity.Id}'";
			var queryp="Select p.Id, p.Anmeldungen__c, p.Warteliste__c, p.Reservierungen__c, p.Stornos__c, p.Gaeste__c, p.Absagen__c, p.Seminargebuehr__c, p.Umsatz_netto__c From Product2 p Where p.Id='";
			
			var stage="{!Opportunity.StageName}";
			
			var fieldName="";
			var oh=false;
			var umsatz=0;
			
			// pruefen wir, was es zu tun gibt
			if ("{!Opportunity.RecordTypeId}"=="012200000004Y3H") {
				if (stage=="Anmeldung" | stage=="Rechnung") fieldName="Anmeldungen__c";
				if (stage=="Reservierung") fieldName="Reservierungen__c";
				if (stage=="Warteliste") fieldName="Warteliste__c";
				if (stage=="Gast") fieldName="Gaeste__c";
				if (stage=="Storno") fieldName="Stornos__c";
			//	if (stage="Absage") fieldName="Absagen__c";
			}
			
			// jetzt geht es richtig los
			var queryoppResult = sforceClient.query(queryopp);
			
			if (queryoppResult.className == "Fault") {
				alert("There was an error: " + queryoppResult.toString());
			
			} else {
				if (queryoppResult.size > 0) {
					//loop all queries
					for (var i=0;i<queryoppResult.records.length;i++) {
						var oppDynaBean = queryoppResult.records[i];						
						// Produkte
						if (stage!="Neu" & stage!="Verhandlung" & stage!="Angebot" & "{!Opportunity.RecordTypeId}"=="012200000004Y3H") {
							var querypResult = sforceClient.query(queryp + oppDynaBean.get("Seminar__c") + "'");
							if (querypResult.className == "Fault") {
								alert("There was an error: " + querypResult.toString());
							} else {
								if (querypResult.size > 0) {
									for (var h=0;h<querypResult.records.length;h++) {
										var pDynaBean = querypResult.records[h];
										// Da sind sie nun unsere Produkte
										
										//alert(fieldName + ": " + pDynaBean.get(fieldName));
										if (stage=="Rechnung" | stage=="Anmeldung" | stage=="Storno") {
											umsatz=pDynaBean.get("Umsatz_netto__c");
											pDynaBean.set("Umsatz_netto__c",umsatz-oppDynaBean.get("Umsatz_Seminar__c"));
										}
										if (stage=="Archiv") {
											// gucken, ob die Opp mal Rechnung oder Storno war, wenn ja, dann muessen wir etwas abziehen
											var ohResult = sforceClient.query("Select o.StageName, o.OpportunityId From OpportunityHistory o Where o.OpportunityId='" + oppDynaBean.get("Id") + "'");
											if (ohResult.className == "Fault") {
												alert("There was an error: " + ohResult.toString());
											} else {
											    var storno=false;
											    var rechnung=false;
												if (ohResult.size > 0) {
													for (var m=0;m<ohResult.records.length;m++) {
														var ohDynaBean = ohResult.records[m];
														if (ohDynaBean.get("StageName")=="Rechnung") rechnung=true;
														if (ohDynaBean.get("StageName")=="Storno") storno=true;
													}
												}
												oh=(storno | rechnung); 
											}
											if (oh) {
												if (rechnung) {
													fieldName="Anmeldungen__c";
												}else if (storno) {
													fieldName="Stornos__c";
												}
												umsatz=pDynaBean.get("Umsatz_netto__c");
												pDynaBean.set("Umsatz_netto__c",umsatz-oppDynaBean.get("Umsatz_Seminar__c"));
											}
										}
										if (fieldName!="") {
											pDynaBean.set(fieldName,pDynaBean.get(fieldName)-1);
										}
										var pSR = sforceClient.update(pDynaBean);
										if (pSR[0].id==null) {
											alert("Fehler beim Aktualisieren des Produktes " + pDynaBean.get("Name"));
										}
									}
								}
							}
						}
						var SR = sforceClient.Delete('{!Opportunity.Id}');
						//alert("SR: " + SR.toString());
						window.top.location.href = "/006/o";
					}
				
				} else {
					// gibt irgendwie keien Opp?
					window.top.location.href = "{!URLFOR($Action.Opportunity.View,  Opportunity.Id, [retUrl=URLFOR($Action.Opportunity.View,  Opportunity.Id)], true)}";
				}
			}
		
		
		}											


</script>

<title>deleteOpportunity</title>
<link href="/css/ie_global.css" rel="stylesheet" type="text/css">
<link href="/css/ie_navigation.css" rel="stylesheet" type="text/css">

<link type="text/css" rel="stylesheet" media="handheld,print,projection,screen,tty,tv" href="/sCSS/9.0/1184184680000/Theme2/default/elements.css"/>

<link type="text/css" rel="stylesheet" media="handheld,print,projection,screen,tty,tv" href="/sCSS/9.0/1184184680000/Theme2/default/common.css"/>

<link type="text/css" rel="stylesheet" media="handheld,print,projection,screen,tty,tv" href="/sCSS/9.0/1184184680000/Theme2/default/rlHovers.css"/>
<link type="text/css" rel="stylesheet" media="aural,braille,embossed" href="/css/assistive.css"/>
<link type="text/css" rel="stylesheet" media="handheld,print,projection,screen,tty,tv" href="/sCSS/9.0/1178748826000/Theme2/dStandard.css"/>
<link type="text/css" rel="stylesheet" media="handheld,print,projection,screen,tty,tv" href="/sCSS/9.0/1185871842000/Theme2/00D200000000CmN/00520000000hAXe/dCustom.css"/>
<link type="text/css" rel="stylesheet" media="handheld,print,projection,screen,tty,tv" href="/sCSS/9.0/1184184680000/Theme2/default/extended.css"/>

</head>
	<body style="background-color:#f3f3ec;" onload="javascript:initPage();" >
    <center>
      <br>
      <table style="display: block" border="0" width="100%" id="progressDisplay">
      <tr><td colspan="3" height="30"/></tr>
      <tr><td/><td width="100%" align="CENTER" nowrap class="status" id="progressMsg"/>
      <div id="outputsave"></div>
      </td></tr>
      <tr><td colspan="3" height="15"/></tr>
      <tr><td/><td width="100%" align="CENTER"><img src="/img/waiting_dots.gif"/></td><td/></tr>
      </table><br>
    </center>
	</body>
</html>